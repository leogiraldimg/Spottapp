<div class="row">
    <div class="col-xs-12">
        <h1>Cadastre-se</h1>
    </div>
</div>
<%= form_for @user do |f| %>
    <%= render 'layouts/error_messages', object: f.object %>
    <div class="row">
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :email %>
                <%= f.text_field :email, class: 'form-control' %>
            </div>    
        </div>
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :nickname %>
                <%= f.text_field :nickname, class: 'form-control' %>
            </div>    
        </div>
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :first_name %>
                <%= f.text_field :first_name, class: 'form-control' %>
            </div>    
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :last_name %>
                <%= f.text_field :last_name, class: 'form-control' %>
            </div>
        </div>
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :birth_date %>
                <%= f.date_field :birth_date, class:'form-control' %>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :password %>
                <%= f.password_field :password, class: 'form-control' %>
            </div>
        </div>
        <div class="col-md-6 col-xs-12">
            <div class="form-group">
                <%= f.label :password_confirmation %>
                <%= f.password_field :password_confirmation, class: 'form-control' %>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 col-xs-12">
            <div class="form-group">
                <%= f.label :country %>
                <%= f.text_field :country, class: 'form-control' %>
            </div>
        </div>
        <div class="col-md-4 col-xs-12">
            <div class="form-group">
                <%= f.label :state %>
                <%= f.text_field :state, class: 'form-control' %>
            </div>
        </div>
        <div class="col-md-4 col-xs-12">
            <div class="form-group">
                <%= f.label :city %>
                <%= f.text_field :city, class: 'form-control' %>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 col-xs-4">
            <%= f.submit 'Cadastrar', class: 'btn btn-primary' %>
        </div>
    </div>

<script>
    var latitude = null;
    var longitude = null;
    var cidade = null;
    var estado = null;
    var pais = null;

    var geolocationPromise = new Promise(function(resolve, reject){
		if(navigator.geolocation){
			navigator.geolocation.getCurrentPosition(function (position) {
				latitude = position.coords.latitude;
				longitude = position.coords.longitude;

				resolve();
			});
		}		
		else {
			resolve();
		}
    });
    geolocationPromise.then(function(){
        var addressPromise = new Promise (function(resolve, reject) {
            var endereco = (latitude != null && latitude != undefined && latitude != ""  ? (latitude + '-') : '')
                    + (longitude != null && longitude != undefined && longitude != ""  ? (longitude + '-') : '');

            var dados = $.ajax({
                url: "https://nominatim.openstreetmap.org/reverse/?format=json&lat=" + latitude +"&lon=" +longitude,
                type: 'GET',
                dataType: 'json',
                contentType: 'aplication/json'
            });
            dados.done(function () {
                cidade = dados.responseJSON.address.city;
                estado = dados.responseJSON.address.state;
                pais = dados.responseJSON.address.country;
                resolve();
            });
            dados.fail(function() {
                console.log("teste") // TODO
            });
        });
        addressPromise.then(function(){
            if (pais) {
                $("#user_country").val(pais);
            }
            if (estado) {
                $("#user_state").val(estado);
            }
            if (cidade) {
                $("#user_city").val(cidade);
            }
        });
    });
</script>
<% end %>
